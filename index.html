<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./assets/imagens/crown.ico">
    <title>Sprint King</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bulma-toast/2.4.0/bulma-toast.min.js"
        integrity="sha512-mmZ7OjPwzgwFPe24uCirB6KvFtUHJqpeHo8cTyWpAvdesiGFRYHDnUKajPt3iWyhaDZ66KTXokBO/Z2kUPTxEw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        @import './assets/css/background.css';
        @import './assets/css/index.css';
    </style>
    <script>
        if (localStorage.getItem("Usuario") === null) {
            location.href = './login.html';
        } 
    </script>
</head>

<body>

    <section class="hero is-fullheight">
        <!-- Hero head: will stick at the top -->
        <div class="hero-head">
            <nav class="navbar is-transparent">
                <div class="container">
                    <div class="navbar-brand">
                        <a class="navbar-item">
                            <p class="title has-text-centered has-text-white mb-0 is-size-2 icon-text">
                                <span>Sprint King</span>
                                <i class="icon mdi mdi-crown has-text-warning pt-5"></i>

                            </p>
                        </a>
                        <a role="button" class="navbar-burger has-text-grey-light" aria-label="menu"
                            aria-expanded="false" data-target="navbar" onclick="alternarNavbarBurger()"
                            id="navbar-burger">
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                            <span aria-hidden="true"></span>
                        </a>
                    </div>
                    <div id="navbar" class="navbar-menu">
                        <hr class="navbar-divider">
                        <div class="navbar-start">
                            <div class="navbar-item has-dropdown is-hoverable  has-text-weight-bold" id="projetos">
                                <a class="navbar-link item">
                                    <span class="is-size-3" id="nome_projeto"></span>
                                </a>

                                <div class="navbar-dropdown">
                                    <div id="dropdown-projetos">

                                    </div>
                                    <hr class="navbar-divider">
                                    <a href="./criar_projeto.html" class="navbar-item">
                                        <span class="icon-text has-text-success-dark has-text-weight-bold">

                                            <span>
                                                Criar Projeto
                                            </span>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>


                        <div class="navbar-end">
                            <a href="./index.html" class="navbar-item item  has-text-weight-bold">
                                Home
                            </a>
                            <a class="navbar-item item  has-text-weight-bold">
                                Sprints
                            </a>

                            <a class="navbar-item item has-text-weight-bold">
                                Calendário
                            </a>

                            <a class="navbar-item item has-text-weight-bold">

                            </a>

                            <div class="navbar-item has-dropdown is-hoverable  has-text-weight-bold"
                                id="dropdown-perfil">
                                <a class="navbar-link item">
                                    <figure class="image is-32x32 mr-2">
                                        <img class=" is-rounded " id="foto_usuario" alt="Foto do Usuário">
                                    </figure>
                                    <span id="saudacao">Olá, </span>
                                </a>

                                <div class="navbar-dropdown">
                                    <a class="navbar-item">
                                        Meu Perfil
                                    </a>
                                    <a class="navbar-item">
                                        Notificações
                                    </a>
                                    <hr class="navbar-divider">
                                    <a class="navbar-item" onclick="sair()">
                                        <span class="icon-text has-text-danger">
                                            <span>Sair</span>
                                            <i class="icon mdi mdi-exit-to-app"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>

                            <a class="navbar-item item has-text-weight-bold" id="navbar-meu-perfil">
                                Meu Perfil
                            </a>
                            <a class="navbar-item item has-text-weight-bold" id="navbar-notificacoes">
                                Notificações
                            </a>

                            <a class="navbar-item item has-text-weight-bold" onclick="sair()" id="navbar-sair">
                                <span class="icon-text has-text-danger">
                                    <span>Sair</span>
                                    <i class="icon mdi mdi-exit-to-app"></i>
                                </span>
                            </a>

                        </div>


                    </div>
                </div>
            </nav>
        </div>


        <!-- Hero content: will be in the middle -->
        <div class="hero-body">
            <div class="container has-text-centered" id="hero-container">

                <div class="box p-6" id="projeto-selecionado">
                    <h1 class="title has-text-left is-size-2" id="nome-projeto">
                        Nome do Projeto
                    </h1>
                    <h2 class="subtitle has-text-left" id="resumo-projeto">
                        Resumo do projeto
                    </h2>

                    <hr>
                    <h1 class="title has-text-left is-size-4">
                        Gerente do Projeto
                    </h1>

                    <div class="column is-4 pl-0">
                        <article class="media">
                            <figure class="media-left">
                                <p class="image is-64x64 is-fullwidth">
                                    <img class="is-rounded" id="foto-gerente"
                                        src="https://bulma.io/images/placeholders/128x128.png">
                                </p>
                            </figure>
                            <div class="media-content">
                                <h1 class="title has-text-left is-size-5 ">
                                    <span class="icon-text">
                                        <span id="nome-gerente">Nome do Gerente</span>
                                        <i class="icon mdi mdi-crown has-text-warning"></i>
                                    </span>
                                </h1>
                                <h2 class="subtitle  has-text-left is-size-6 info-membro" id="email-gerente">
                                    email@email.com</h2>
                            </div>
                        </article>
                    </div>
                    <hr>
                    <h1 class="title has-text-left is-size-4 is-size-5-touch">
                        <span>Membros</span>
                        <a class="ml-2 is-medium is-rounded is-inverted" id="botao-adicionar-membro"
                            onclick="alternarModalAddMembro()">
                            <span class="icon-text is-size-6-touch has-text-link-dark has-text-weight-bold">
                                <span class="icon">
                                    <i class="mdi mdi-account-plus-outline"></i>
                                </span>
                                <span class="">
                                    Adicionar Membro
                                </span>


                            </span>
                        </a>
                    </h1>
                    <br>
                    <div class="columns is-multiline" id="membros-projeto">

                    </div>
                    <div class="notification" id="aviso-membros-vazio">
                        <p class="is-size-4 is-size-6-touch has-text-centered has-text-weight-bold">

                            <span>
                                Seu projeto ainda não possui membros ...
                            </span>

                        </p>
                    </div>

                </div>

                <p id="aviso">
                    <span class="title has-text-link-light">
                        Você não faz parte de nenhum projeto!
                    </span>
                    <br>
                    <br>
                    <span class="subtitle has-text-warning">
                        <a href="./criar_projeto.html">Clique aqui para criar seu primeiro projeto.</a>
                    </span>
                </p>
            </div>

        </div>

        <div class="modal" id="modal-adicionar-membro">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Adicionar novo membro</p>
                    <button class="delete" aria-label="close" onclick="alternarModalAddMembro()"></button>
                </header>
                <section class="modal-card-body">

                    <form action="" onsubmit="return buscaUsuarioPorEmail(this)">
                        <label class="label is-size-5" for="email-membro">Insira o e-mail do usuário:</label>
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <input type="email" required class="input" placeholder="example@email.com"
                                    list="usuarios" name="email" id="email-membro">
                            </div>

                            <div class="control">
                                <button class="button">
                                    <i class="icon mdi mdi-magnify"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="resultado">
                        <hr>
                        <div class="notification is-danger" id="aviso-usuario-nao-encontrado">
                            <p class="has-text-centered has-text-weight-bold">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-account-multiple-remove-outline"></i>
                                    </span>
                                    <span>
                                        Nenhum usuário encontrado
                                    </span>
                                </span>
                            </p>
                        </div>
                        <p class="title is-size-5" id="aviso-usuario-encontrado"> Usuário Encontrado:</p>
                        <article class="media" id="usuario-encontrado">
                            <figure class="media-left">
                                <p class="image is-32x32 is-fullwidth">
                                    <img class="is-rounded" src="https://bulma.io/images/placeholders/128x128.png"
                                        id="foto-resultado">
                                </p>
                            </figure>
                            <div class="media-content">
                                <h1 class="title has-text-left is-size-7 info-membro" id="nome-resultado">
                                    Usuário Encontrado
                                </h1>
                                <h2 class="subtitle  has-text-left is-size-7 info-membro" id="email-resultado">
                                    email@email.com</h2>
                            </div>

                            <div class="media-right mr-2" id="form-item-1">
                                <form action="" onsubmit="return adicionarMembro(this)" id="form-adicionar-membro">
                                    <div class="field">

                                        <div class="select is-small">
                                            <select name="cargo">
                                                <option value="desenvolvedor">Desenvolvedor</option>
                                                <option value="design">Design</option>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="media-right" id="form-item-2">
                                <button class="button is-small is-success is-fullwidth" form="form-adicionar-membro">
                                    <span class="has-text-weight-bold">
                                        Adicionar
                                    </span>
                                </button>
                            </div>

                            <div class="media-right mt-1" id="aviso-eh-membro">

                                <p class="title is-size-6 has-text-dark">Este usuário já é membro do projeto</p>

                            </div>

                        </article>
                    </div>

                </section>
            </div>

        </div>

        <div class="modal" id="modal-remover-membro">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box p-6">
                    <p class="subtitle is-size-3">
                        Deseja remover o membro <span class="has-text-weight-bold" id="nome-membro-remover"></span>
                        do projeto <span class="has-text-weight-bold" id="nome-projeto-remover"></span>?
                    </p>
                    <hr>
                    <div class="columns">

                        <div class="column is-6">
                            <button class="button is-fullwidth is-danger has-text-weight-bold"
                                onclick="alternarModalRemoverMembro()">
                                Não
                            </button>
                        </div>

                        <div class="column is-6">
                            <button class="button is-fullwidth is-success has-text-weight-bold" id="botao-remover-sim">
                                Sim
                            </button>
                        </div>


                    </div>
                </div>
            </div>

        </div>

    </section>



</body>

<script>

    let usuario = JSON.parse(localStorage.getItem("Usuario"))
    console.log(usuario)
    let projetos = [];
    let membros = [];
    let gerente = null;
    let usuario_encontrado = null;
    let projeto_selecionado;


    xhttp = new XMLHttpRequest();
    xhttp.onload = function () {
        // console.log(this.responseText);
        resposta = JSON.parse(this.responseText);
        if (resposta.erro == 0) {

            projetos = resposta.projetos;
            carregarProjetos();
            if (usuario.projeto_selecionado !== '') {
                getProjetoSelecionado();

            } else if (projetos.length > 0) {

                // Caso o usuário não tenha nenhum projeto selecionado,
                // mas seja membro de um projeto, o redireciona para a página
                // do projeto existente.

                id = projetos[0].id

                selecionarProjeto(id);
            }

        } else {
            document.getElementById('aviso').style.display = 'block';
            document.getElementById('projetos').style.display = 'none';
            document.getElementById('projeto-selecionado').style.display = 'none';
        }

    };
    xhttp.open("GET", "./controle/getProjetosEmail.php", true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhttp.send();


    //Define as informações do usuário logado
    document.getElementById('foto_usuario').src = './../' + usuario.foto
    document.getElementById('saudacao').innerText += '     ' + usuario.nome.split(' ')[0]


    function carregarProjetos() {

        const columns = document.getElementById('dropdown-projetos')


        projetos.filter(projeto => projeto.id != usuario.projeto_selecionado).forEach(projeto => {
            // console.log(projeto)
            const item = document.createElement('a')
            item.classList.add('navbar-item')


            const texto = document.createElement('p')
            texto.classList.add('level', 'is-mobile')

            const nome = document.createElement('span')
            nome.innerText = projeto.nome
            nome.classList.add('has-text-left', 'level-left')

            texto.append(nome)

            item.append(texto)
            item.id = projeto.id

            item.addEventListener('click', function a() { selecionarProjeto(item.id) })

            columns.insertBefore(item, columns.firstChild)
        });

    }

    function getProjetoSelecionado() {
        xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            console.log(this.responseText)
            resposta = JSON.parse(this.responseText);

            if (resposta.erro == 0) {
                projeto_selecionado = resposta.projeto;
                carregarInformacoesProjeto();

                if (verificarMembro(usuario.email) === false) {
                    bulmaToast.toast({
                        message: `Você foi removido do projeto <strong>${projeto_selecionado.nome}</strong>! Redirecionando...`,
                        type: 'is-danger is-light'
                    })

                    id = projetos[0].id

                    setTimeout(() => { selecionarProjeto(id) }, 3000);
                }
            }


        };

        xhttp.open("POST", "./controle/getProjetoPorId.php", true);
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

        dados = new FormData();
        dados.append('id', usuario.projeto_selecionado)

        xhttp.send(new URLSearchParams(dados).toString());

    }

    function selecionarProjeto(id) {
        console.log(id)

        xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            console.log(this.responseText)
            resposta = JSON.parse(this.responseText);

            if (resposta.erro == 0) {

                usuario.projeto_selecionado = id

                localStorage.setItem('Usuario', JSON.stringify(usuario))

                location.href = './index.html'

            }

        };

        xhttp.open("POST", "./controle/alterarProjetoSelecionado.php", true);
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

        dados = new FormData();
        dados.append('usuario', usuario.id)
        dados.append('projeto', id)

        xhttp.send(new URLSearchParams(dados).toString());


    }

    function sair() {
        localStorage.removeItem("Usuario");
        xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            console.log(this.responseText);
        };
        xhttp.open("GET", "./controle/sair.php", true);
        xhttp.send();
        location.href = './login.html';
    }

    function carregarInformacoesProjeto() {

        document.getElementById('nome_projeto').innerText = projeto_selecionado.nome
        document.getElementById('projeto-selecionado').style.display = 'block';

        // Alterando informações do projeto
        document.getElementById('nome-projeto').innerText = projeto_selecionado.nome
        document.getElementById('resumo-projeto').innerText = projeto_selecionado.resumo

        gerente = projeto_selecionado.membros.filter(membro => membro.cargo === "gerente")[0]
        const membros = projeto_selecionado.membros.filter(membro => membro.cargo !== "gerente")

        //Verifica se o usuário é gerente do projeto selecionado
        if (usuario.id == gerente.id) {
            document.getElementById('botao-adicionar-membro').style.display = 'inline-flex';
        }

        // Alterando as informações do gerente do projeto
        document.getElementById('nome-gerente').innerText = gerente.nome
        document.getElementById('email-gerente').innerText = gerente.email
        document.getElementById('foto-gerente').src = './../' + gerente.foto

        console.log(gerente)

        const columns = document.getElementById('membros-projeto')

        if (membros.length == 0) {
            document.getElementById('aviso-membros-vazio').style.display = 'block'
        }
        else {
            membros.forEach(membro => {

                console.log(membro)

                const column = document.createElement('div')
                column.classList.add('column', 'is-4')

                const article = document.createElement('article')
                article.classList.add('media')

                const figure = document.createElement('figure')
                figure.classList.add('media-left')

                const pImage = document.createElement('p')
                pImage.classList.add("image", "is-64x64", "is-fullwidth")

                const img = document.createElement('img')
                img.classList.add('is-rounded', 'foto-membro')
                img.src = "./../" + membro.foto

                const content = document.createElement('div')
                content.classList.add('media-content')

                const nomeMembro = document.createElement('h1')
                nomeMembro.classList.add('title', 'has-text-left', 'is-size-5', 'info-membro')
                nomeMembro.innerText = membro.nome

                const emailMembro = document.createElement('h2')
                emailMembro.classList.add('subtitle', 'has-text-left', 'is-size-6', 'mb-2', 'info-membro')
                emailMembro.innerHTML = `${membro.email}<br>${membro.cargo}`

                columns.append(column)
                column.append(article)

                article.append(figure)
                figure.append(pImage)
                pImage.append(img)

                article.append(content)
                content.append(nomeMembro)
                content.append(emailMembro)


                if (usuario.id == gerente.id) {

                    // const rightContent = document.createElement('div')
                    // rightContent.classList.add('media-right', 'has-text-centered')
                    const remover = document.createElement('h2')
                    remover.classList.add('subtitle', 'has-text-left', 'is-size-6', 'mt-0', 'info-membro')

                    const botaoRemover = document.createElement('a')
                    botaoRemover.classList.add('has-text-danger', 'has-text-left')
                    botaoRemover.ariaLabel = "botão remover membro"


                    botaoRemover.addEventListener('click', function a() { alternarModalRemoverMembro(membro) })


                    const span = document.createElement('span')
                    span.classList.add('has-text-left')
                    span.innerText = 'Remover Membro'

                    const iconeTrash = document.createElement('i')
                    iconeTrash.classList.add('mdi', 'mdi-account-minus')

                    content.append(remover)
                    remover.append(botaoRemover)
                    botaoRemover.append(span)
                    // spanIcone.append(iconeTrash)
                }

            })
        }


    }

    function alternarModalAddMembro() {

        const modal = document.getElementById('modal-adicionar-membro')

        document.getElementById('aviso-usuario-nao-encontrado').style.display = 'none'
        document.getElementById('aviso-usuario-encontrado').style.display = 'none'
        document.getElementById('usuario-encontrado').style.display = 'none'
        document.getElementById('email-membro').value = ''

        usuario_encontrado = null

        if (modal.classList.contains('is-active')) {
            modal.classList.remove('is-active')
        } else {
            modal.classList.add('is-active')
        }
    }

    function buscaUsuarioPorEmail(formulario) {
        try {
            document.getElementById('aviso-usuario-nao-encontrado').style.display = 'none'
            document.getElementById('aviso-usuario-encontrado').style.display = 'none'
            document.getElementById('usuario-encontrado').style.display = 'none'

            xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                console.log(this.responseText)
                resposta = JSON.parse(this.responseText);

                if (resposta.erro == 0) {
                    usuario_encontrado = resposta.usuario

                    ehMembro = verificarMembro(usuario_encontrado.email)

                    if (ehMembro) {
                        document.getElementById('aviso-eh-membro').style.display = 'flex'
                        document.getElementById('form-item-1').style.display = 'none'
                        document.getElementById('form-item-2').style.display = 'none'

                    } else {
                        document.getElementById('aviso-eh-membro').style.display = 'none'
                        document.getElementById('form-item-1').style.display = 'flex'
                        document.getElementById('form-item-2').style.display = 'flex'
                    }

                    document.getElementById('usuario-encontrado').style.display = 'flex'
                    document.getElementById('aviso-usuario-encontrado').style.display = 'flex'

                    document.getElementById('nome-resultado').innerText = usuario_encontrado.nome
                    document.getElementById('email-resultado').innerText = usuario_encontrado.email
                    document.getElementById('foto-resultado').src = './../' + usuario_encontrado.foto



                }

                else {
                    document.getElementById('aviso-usuario-nao-encontrado').style.display = 'flex'
                }
            };

            xhttp.open("POST", "./controle/getUsuarioPorEmail.php", true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            dados = new FormData(formulario);

            xhttp.send(new URLSearchParams(dados).toString());

            return false;

        } catch (error) {
            console.log(error)
            return false;
        }
    }

    function verificarMembro(email) {

        return projeto_selecionado.membros.filter(membro => membro.email == email).length > 0


    }

    function adicionarMembro(formulario) {
        try {
            xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                console.log(this.responseText)
                resposta = JSON.parse(this.responseText);

                if (resposta.erro == 0) {
                    bulmaToast.toast({
                        message: `Usuário <strong>${usuario_encontrado.nome}</strong> foi adicionado como membro do projeto <strong>${projeto_selecionado.nome}</strong>!`,
                        type: 'is-success is-light'
                    })

                    setTimeout(function () {

                        location.href = './index.html'

                    }, 2000)
                }

            };

            xhttp.open("POST", "./controle/adicionarMembro.php", true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            dados = new FormData(formulario);
            dados.append('id_usuario', usuario_encontrado.id)
            dados.append('id_projeto', projeto_selecionado.id)

            xhttp.send(new URLSearchParams(dados).toString());

            return false;

        } catch (error) {
            console.log(error)
            return false;
        }
    }

    function alternarModalRemoverMembro(membro) {

        const modal = document.getElementById('modal-remover-membro')

        if (modal.classList.contains('is-active')) {
            modal.classList.remove('is-active')
        } else {

            botao = document.getElementById('botao-remover-sim')

            botao.addEventListener('click', function a() { removerMembro(membro) })

            document.getElementById('nome-membro-remover').innerText = membro.nome
            document.getElementById('nome-projeto-remover').innerText = projeto_selecionado.nome


            modal.classList.add('is-active')
        }

    }

    function removerMembro(membro) {
        try {
            xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                console.log(this.responseText)
                resposta = JSON.parse(this.responseText);

                if (resposta.erro == 0) {
                    bulmaToast.toast({
                        message: `Membro <strong>${membro.nome}</strong> foi removido do projeto <strong>${projeto_selecionado.nome}</strong>!`,
                        type: 'is-danger is-light'
                    })

                    setTimeout(function () {
                        location.href = './index.html'

                    }, 2000)
                }

            };

            xhttp.open("POST", "./controle/removerMembro.php", true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            dados = new FormData();
            dados.append('id_usuario', membro.id)
            dados.append('id_projeto', projeto_selecionado.id)

            xhttp.send(new URLSearchParams(dados).toString());

            return false;

        } catch (error) {
            console.log(error)
            return false;
        }
    }

    function alternarNavbarBurger() {

        if (!document.getElementById('navbar-burger').classList.contains('is-active')) {

            document.getElementById('navbar-burger').classList.add('is-active')
            document.getElementById('navbar').classList.add('is-active')

            document.getElementById('navbar-meu-perfil').style.display = 'flex';
            document.getElementById('navbar-notificacoes').style.display = 'flex';
            document.getElementById('navbar-sair').style.display = 'flex';

            document.getElementById('dropdown-perfil').style.display = 'none';



        } else {

            document.getElementById('navbar-burger').classList.remove('is-active')
            document.getElementById('navbar').classList.remove('is-active')

            document.getElementById('navbar-meu-perfil').style.display = 'none';
            document.getElementById('navbar-notificacoes').style.display = 'none';
            document.getElementById('navbar-sair').style.display = 'none';

            document.getElementById('dropdown-perfil').style.display = 'flex';
        }


    }


</script>

</html>